name: Test macOS Recording

on:
  workflow_dispatch:
  push:
    branches:
      - raylib-record
      - raylib-record-macos-test
      - master

jobs:
  test_recording:
    name: Test macOS Recording
    runs-on: macos-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Cache commit date
        run: echo "CACHE_COMMIT_DATE=$(git log -1 --pretty='format:%cd' --date=format:'%Y-%m-%d-%H:%M')" >> $GITHUB_ENV

      - name: Homebrew cache
        uses: ./.github/workflows/auto-cache
        with:
          path: ~/Library/Caches/Homebrew
          key: brew-macos-${{ env.CACHE_COMMIT_DATE }}-${{ github.sha }}
          restore-keys: |
            brew-macos-${{ env.CACHE_COMMIT_DATE }}
            brew-macos

      - name: Install dependencies
        run: ./tools/mac_setup.sh
        env:
          PYTHONWARNINGS: default
          HOMEBREW_DISPLAY_INSTALL_TIMES: 1

      - name: Getting scons cache
        uses: ./.github/workflows/auto-cache
        with:
          path: /tmp/scons_cache
          key: scons-${{ runner.arch }}-macos-${{ env.CACHE_COMMIT_DATE }}-${{ github.sha }}
          restore-keys: |
            scons-${{ runner.arch }}-macos-${{ env.CACHE_COMMIT_DATE }}
            scons-${{ runner.arch }}-macos

      - name: Build openpilot
        run: . .venv/bin/activate && scons -j$(nproc)

      - name: Run recording test
        run: |
          . .venv/bin/activate
          # Run for 5 seconds then kill
          timeout 5 env RECORD=1 python system/ui/spinner.py || true

          # Check if output file was created
          if [ -f output.mp4 ]; then
            echo "Recording created successfully!"
            ls -lh output.mp4

            # Get video info
            if command -v ffprobe &> /dev/null; then
              ffprobe -v error -show_entries stream=width,height,codec_name,pix_fmt -of default=noprint_wrappers=1 output.mp4
            fi
          else
            echo "ERROR: Recording file not created"
            exit 1
          fi

      - name: Upload recording artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: macos-recording-test
          path: output.mp4
          if-no-files-found: warn
          retention-days: 7
