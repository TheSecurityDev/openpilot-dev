<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UI Diff Report</title>
  <style>
    body { font-family: sans-serif; margin: 0.75em; }
    h1, h2, h3, h4 { margin: 0.5em 0 0.25em; }
    #nav { display: flex; flex-wrap: wrap; gap: 0.6em; margin: 0.75em 0; }
    #nav button { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0; border: 2px solid #aaa; border-radius: 6px; cursor: pointer; background: #f5f5f5; overflow: hidden; width: 200px; }
    #nav button img { width: 100%; height: auto; display: block; }
    #nav button .nav-title { font-size: 0.82rem; padding-top: 0.3rem; text-align: center; font-weight: 600; }
    #nav button .nav-desc { font-size: 0.60rem; padding: 0.12rem 0.25rem 0.35rem; text-align: center; color: #333; }
    #nav button.active { border-color: #0078d4; background: #e5f2fc; }
    #nav button.active .nav-title { color: #0078d4; }
    table.videos { width: 100%; }
    @media (max-width: 800px) {
      /* responsive grid for nav: 2–3 columns that fill the row */
      #nav { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5em; margin: 0.5em 0; }
      #nav button { width: 100%; }
      table.videos tr { display: flex; flex-direction: column; }
      table.videos td { width: 100% !important; }
    }
  </style>
</head>
<body>
  <h2>UI Diff</h2>
  <p><strong>Results:</strong> $RESULT_TEXT</p>
  <div id='player'></div>
  <div id='nav'></div>
  <script>
    const LABELS = ['Video 1', 'Video 2', 'Pixel Diff'];
    const chunks = $CHUNKS_JSON;

    const scenes = [
      { title: 'Full Video', desc: '', srcs: ['$VIDEO1_SRC', '$VIDEO2_SRC', '$DIFF_SRC'], loop: false },
      ...chunks.map(({ start_frame, end_frame, duration, clips, thumb }, i) => ({
        title: `Diff Group ${i + 1}`,
        desc: `frames ${start_frame}-${end_frame} (${duration}f, ${(duration / 30.0).toFixed(2)}s)`,
        srcs: [clips.video1, clips.video2, clips.diff],
        thumb: thumb || '',
        loop: true,
      })),
    ];

    // Static 3-video player — sources are swapped on scene change.
    document.getElementById('player').innerHTML = `<table class='videos'><tbody><tr>
      ${LABELS.map((label, i) => `<td width='33%'><h4>${label}</h4>
        <video id='v${i}' width='100%' muted playsinline><source type='video/mp4'></video></td>`).join('')}
    </tr></tbody></table>`;
    const vids = [0, 1, 2].map(i => document.getElementById(`v${i}`));

    // Sync: keep all three videos at the same playhead.
    const isEnded = v => v.ended || (Number.isFinite(v.duration) && v.currentTime >= v.duration - 0.05);
    vids.forEach(v => {
      v.addEventListener('timeupdate', () => vids.forEach(o => {
        if (o !== v && !isEnded(o) && Math.abs(v.currentTime - o.currentTime) > 0.1) {
          o.currentTime = v.currentTime;
          if (o.paused) o.play();
        }
      }));
      v.addEventListener('ended', () => {
        v.pause();
        if (vids.every(isEnded)) { vids.forEach(v => { v.currentTime = 0; v.play(); }); }
      });
    });

    // Switch to a scene: swap sources, reload, play, and update ?selected query param.
    function switchTo(i) {
      vids.forEach(v => v.pause());
      const { srcs, loop } = scenes[i];
      vids.forEach((v, j) => { v.loop = loop; v.querySelector('source').src = srcs[j]; v.load(); v.play().catch(() => {}); });
      document.querySelectorAll('#nav button').forEach((b, j) => b.classList.toggle('active', j === i));
      // Minimal URL update without page reload.
      const newUrl = new URL(window.location);
      i > 0 ? newUrl.searchParams.set('selected', i) : newUrl.searchParams.delete('selected');
      history.replaceState(null, '', newUrl);
    }

    // Build nav buttons (hide the nav entirely when there are no diff segments).
    const navEl = document.getElementById('nav');
    if (scenes.length > 1) {
      scenes.forEach((s, i) => {
        const b = document.createElement('button');
        if (s.thumb) {
          const img = document.createElement('img');
          img.src = s.thumb;
          img.alt = s.title;
          b.appendChild(img);
        }
        const title = document.createElement('span');
        title.className = 'nav-title';
        title.textContent = s.title;
        const desc = document.createElement('span');
        desc.className = 'nav-desc';
        desc.textContent = s.desc || '';
        b.title = (s.title + (s.desc ? ' — ' + s.desc : '')).trim();
        b.appendChild(title);
        b.appendChild(desc);
        b.onclick = () => switchTo(i);
        navEl.appendChild(b);
      });
    } else {
      navEl.style.display = 'none';
    }

    // On load: if ?selected=N is present, select that scene; otherwise default to 0.
    (function selectInitialFromQuery() {
      const params = new URLSearchParams(window.location.search);
      const v = parseInt(params.get('selected') || '0', 10);
      const initial = (!Number.isNaN(v) && v >= 0 && v < scenes.length) ? v : 0;
      switchTo(initial);
    })();
  </script>
</body>
</html>
