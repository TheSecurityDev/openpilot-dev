<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UI Diff Report</title>
  <style>
    body { font-family: sans-serif; margin: 0.75em; }
    h1, h2, h3, h4 { margin: 0.5em 0 0.25em; }
    #nav { display: flex; flex-wrap: wrap; gap: 0.6em; margin: 1em 0;}
    #nav button { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0; border: 2px solid #aaa; border-radius: 6px; cursor: pointer; background: #f5f5f5; width: 200px; position: relative; }
    #nav button img { width: 100%; }
    #nav button.active { border-color: #0078d4; background: #e5f2fc; border-width: 3px; }
    #nav button.type-insert { border-color: #2a9d2a; }
    #nav button.type-insert.active { border-color: #1a7a1a; background: #e6f7e6; }
    #nav button.type-delete { border-color: #c0392b; }
    #nav button.type-delete.active { border-color: #922b21; background: #fde8e6; }
    table.videos { width: 100%; }
    .nav-row { display: flex; align-items: center; gap: 8px; width: 100%; }
    .nav-index { position: absolute; left: 8px; bottom: 6px; font-weight: 600; color: #777; font-size: 0.82rem; }
    .nav-index.hidden { display: none; }
    .nav-action { flex: 1; text-align: center; font-size: 0.86rem; font-weight: 600; color: #222; }
    .nav-desc { font-size: 0.60rem; padding: 0.12rem 0.25rem 0.35rem; text-align: center; color: #333; }
    .no-video { display: none; width: 100%; min-height: 180px; border: 1px dashed #aaa; border-radius: 4px; background: #fafafa; color: #666; font-size: 0.95rem; align-items: center; justify-content: center; text-align: center; }
    @media (max-width: 800px) {
      #nav { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5em; }
      #nav button { width: 100%; }
      table.videos tr { display: flex; flex-direction: column; }
      table.videos td { width: 100% !important; }
    }
  </style>
</head>
<body>
  <h2>UI Diff</h2>
  <p><strong>Results:</strong> $RESULT_TEXT</p>
  <div id='player'></div>
  <hr>
  <div id='nav'></div>
  <script>
    const LABELS = ['Video 1', 'Video 2', 'Pixel Diff'];
    const chunks = $CHUNKS_JSON;

    const frames_label = (n) => `${n} frame${n !== 1 ? 's' : ''}`;
    const frames_range_label = (start, end) =>
      start === end ? `frame ${start + 1}` : `frames ${start + 1}–${end + 1}`;
    const video_frames_range_label = (v, start, end) => `video ${v}: ${frames_range_label(start, end)}`;

    const scenes = [
      { title: 'Full Video', desc: '', type: '', srcs: ['$VIDEO1_SRC', '$VIDEO2_SRC', '$DIFF_SRC'], loop: true },
      ...chunks.map(({ v1_start, v1_end, v2_start, v2_end, v1_count, v2_count, type, clips, thumb }, i) => {
        // Build action text based on type and frame counts
        let actionText;
        if (type === 'insert') {
          actionText = `Added ${frames_label(v2_count)}`;
        } else if (type === 'delete') {
          actionText = `Removed ${frames_label(v1_count)}`;
        } else if (type === 'replace') {
          actionText = (v1_count === v2_count) ? `Changed ${frames_label(v1_count)}` : `Changed ${v1_count}→${v2_count} frames`;
        } else {
          actionText = frames_label(Math.max(v1_count || 0, v2_count || 0));
        }

        // Build description with frame ranges
        let desc = '';
        if (type === 'insert') {
          desc = video_frames_range_label(2, v2_start, v2_end);
        } else if (type === 'delete') {
          desc = video_frames_range_label(1, v1_start, v1_end);
        } else if (type === 'replace') {
          const a = video_frames_range_label(1, v1_start, v1_end);
          const b = video_frames_range_label(2, v2_start, v2_end);
          desc = `${a} → ${b}`;
        } else {
          const parts = [];
          if (v1_count) parts.push(video_frames_range_label(1, v1_start, v1_end));
          if (v2_count) parts.push(video_frames_range_label(2, v2_start, v2_end));
          desc = parts.join(' | ');
        }

        return {
          idx: i + 1,
          title: actionText || `Group ${i + 1}`,
          desc: desc,
          type: type || '',
          srcs: [clips.video1, clips.video2, clips.diff],
          thumb: thumb || '',
          loop: true,
        };
      }),
    ];

    // Build video player table
    document.getElementById('player').innerHTML = `<table class='videos'><tbody><tr>
        ${LABELS.map((label, i) => `<td width='33%'>
          <h4>${label}</h4>
          <div>
            <video id='v${i}' width='100%' muted playsinline><source type='video/mp4'></video>
            <div id='nv${i}' class='no-video'>No video</div>
          </div>
        </td>`).join('')}
      </tr></tbody></table>`;
    const videos = [0, 1, 2].map(i => document.getElementById(`v${i}`));
    const noVideoEls = [0, 1, 2].map(i => document.getElementById(`nv${i}`));
    let active = [true, true, true];  // Whether each video is active/exists for the current scene

    let loopEnabled = false;
    let restarting = false;

    const isEnded = (v, i) => !active[i] || v.ended || (Number.isFinite(v.duration) && v.currentTime >= v.duration - 0.05);

    // Sync: keep playing videos at the same playhead
    videos.forEach((v, vi) => {
      v.addEventListener('timeupdate', () => {
        if (restarting || !active[vi]) return;
        videos.forEach((o, oi) => {
          if (o === v || !active[oi] || isEnded(o, oi)) return;
          const target = Number.isFinite(o.duration) ? Math.min(v.currentTime, o.duration) : v.currentTime;
          if (Math.abs(target - o.currentTime) > 0.1) {
            o.currentTime = target;
            if (o.paused) o.play().catch(() => {});
          }
        });
      });

      // When a video ends, pause it and let the longer ones continue. Only restart the whole scene once ALL videos have finished.
      v.addEventListener('ended', () => {
        if (!active[vi]) return;
        v.pause();
        if (!restarting && loopEnabled && videos.every((x, i) => isEnded(x, i))) {
          restarting = true;
          videos.forEach((x, i) => { if (active[i]) x.currentTime = 0; });
          // Brief delay so all currentTime resets settle before we call play().
          setTimeout(() => {
            restarting = false;
            videos.forEach((x, i) => { if (active[i]) x.play().catch(() => {}); });
          }, 50);
        }
      });
    });

    // Switch to a different scene (chunk group)
    function switchTo(idx) {
      restarting = false;
      videos.forEach(v => { v.pause(); v.loop = false; });  // never use native loop
      const { srcs, loop, type } = scenes[idx];
      loopEnabled = loop;

      videos.forEach((v, vi) => {
        const src = srcs[vi];
        active[vi] = !!src;
        const source = v.querySelector('source');
        source.src = src || '';
        v.load();
        if (active[vi]) {
          v.style.display = '';
          noVideoEls[vi].style.display = 'none';
          v.play().catch(() => {});
        } else {
          v.style.display = 'none';
          noVideoEls[vi].style.display = 'flex';
        }
      });

      document.querySelectorAll('#nav button').forEach((b, j) => b.classList.toggle('active', j === idx));
      const newUrl = new URL(window.location);
      idx > 0 ? newUrl.searchParams.set('selected', idx) : newUrl.searchParams.delete('selected');
      history.replaceState(null, '', newUrl);
    }

    const TYPE_ICON = { replace: '✏️', insert: '➕', delete: '➖' };
    const TYPE_NAV_CLASSES = { insert: 'type-insert', delete: 'type-delete' };

    // Build nav buttons (hide the nav entirely when there are no diff segments).
    const navEl = document.getElementById('nav');
    if (scenes.length > 1) {
      scenes.forEach((scene, i) => {
        const btn = document.createElement('button');
        const navClass = TYPE_NAV_CLASSES[scene.type];
        if (navClass) btn.classList.add(navClass);
        if (scene.thumb) {
          const img = document.createElement('img');
          img.src = scene.thumb;
          img.alt = scene.title;
          btn.appendChild(img);
        }
        const header = document.createElement('div');
        header.className = 'nav-row';
        const idxEl = document.createElement('span');
        idxEl.className = 'nav-index';
        if (scene.idx) {
          idxEl.textContent = scene.idx + '.';
        } else {
          idxEl.classList.add('hidden');
        }
        const actionEl = document.createElement('span');
        actionEl.className = 'nav-action';
        const icon = TYPE_ICON[scene.type] || '';
        actionEl.textContent = (icon ? icon + ' ' : '') + scene.title;
        header.appendChild(actionEl);
        header.appendChild(idxEl);
        const desc = document.createElement('span');
        desc.className = 'nav-desc';
        desc.textContent = scene.desc || '';
        btn.title = ((scene.title || '') + (scene.desc ? ' — ' + scene.desc : '')).trim();
        btn.appendChild(header);
        btn.appendChild(desc);
        btn.onclick = () => switchTo(i);
        navEl.appendChild(btn);
      });
    } else {
      navEl.style.display = 'none';
    }

    // On load: if ?selected=N is present, select that scene; otherwise default to 0.
    (function selectInitialFromQuery() {
      const params = new URLSearchParams(window.location.search);
      const v = parseInt(params.get('selected') || '0', 10);
      const initial = (!Number.isNaN(v) && v >= 0 && v < scenes.length) ? v : 0;
      switchTo(initial);
    })();
  </script>
</body>
</html>
