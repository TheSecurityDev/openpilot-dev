<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UI Diff Report</title>
  <style>
    h1, h2, h3, h4 { margin: 0.5em 0 0.25em; }
    table.videos { width: 100%; }
    @media (max-width: 800px) {
      table.videos tr { display: flex; flex-direction: column; }
      table.videos td { width: 100% !important; }
    }
  </style>
</head>
<body>
  <h2>UI Diff</h2>
  <div id='main'></div>
  <hr>
  <p><strong>Results:</strong> $RESULT_TEXT</p>
  <div id='chunks'></div>
  <script>
    const LABELS = ['Video 1', 'Video 2', 'Pixel Diff'];

    // Shared helper: renders a 3-column video row; attrs[] passes extra attributes per video.
    function videoRow(srcs, attrs = []) {
      const cells = srcs.map((src, i) => `
        <td width='33%'><h4>${LABELS[i]}</h4>
          <video width='100%' autoplay muted playsinline ${attrs[i] ?? ''}>
            <source src='${src}' type='video/mp4'>
          </video></td>`).join('');
      return `<table class='videos'><tbody><tr>${cells}</tr></tbody></table>`;
    }

    // --- Main full-video section with sync ---
    const IDS = ['v1', 'v2', 'vd'];
    document.getElementById('main').innerHTML = videoRow(
      ['$VIDEO1_SRC', '$VIDEO2_SRC', '$DIFF_SRC'],
      [`id='v1' onplay='sync()'`, `id='v2' onplay='sync()'`, `id='vd'`],
    );
    const videos = IDS.map(id => document.getElementById(id));

    const isEnded = v => v.ended || (Number.isFinite(v.duration) && v.currentTime >= v.duration - 0.05);
    const playAll = () => videos.forEach(v => v.play());

    function sync() {
      const t = Math.min(...videos.map(v => v.currentTime));
      videos.forEach(v => { v.currentTime = t; });
      playAll();
    }

    videos.forEach(v => {
      v.addEventListener('timeupdate', () => videos.forEach(o => {
        if (o !== v && !isEnded(o) && Math.abs(v.currentTime - o.currentTime) > 0.1) {
          o.currentTime = v.currentTime;
          if (o.paused) o.play();
        }
      }));
      v.addEventListener('ended', () => {
        v.pause();
        if (videos.every(isEnded)) { videos.forEach(v => v.currentTime = 0); playAll(); }
      });
    });

    // --- Chunk sections ---
    const chunks = $CHUNKS_JSON;
    if (chunks.length) {
      document.getElementById('chunks').innerHTML = '<hr><h2>Different Sections</h2>'
        + chunks.map(({ start_frame, end_frame, duration, clips }, i) => `
          <h3>Section ${i + 1}: frames ${start_frame}\u2013${end_frame} (${duration} frame${duration !== 1 ? 's' : ''})</h3>
          ${videoRow([clips.video1, clips.video2, clips.diff], ['loop', 'loop', 'loop'])}`
        ).join('');
    }
  </script>
</body>
</html>
